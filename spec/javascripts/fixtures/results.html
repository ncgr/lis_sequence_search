<!DOCTYPE html>
<html>
    <head>
        <title>LIS Sequence Search</title>
    </head>
    <body>
        <div id="show">
            <h1>Search Results</h1>
            <p class="small right"><a href="/quorum/jobs">Search Again &raquo;</a></p>
            <div id="results" class="ui-widget ui-widget-content ui-corner-all">
                <div id="results-menu" class="ui-widget-header ui-corner-all">
                    <span id="menu-loading">
                        <p>Searching... <img alt="Loading" src="/assets/quorum/loading.gif" /></p>
                    </span>
                    <span id="algorithms"></span>
                    <button id="view">view selected</button>
                    <span id="tools">
                        <button id="remove-filters">remove filter(s)</button>
                        <span>
                            <button id="filters">select filter</button>
                        </span>
                        <ul>
                            <li><a href="#" id="top-hits">top hit(s)</a></li>
                            <li><a href="#" id="top-hits-per-ref">top hit(s) per reference</a></li>
                            <li><a href="#" id="top-hits-per-ref-seq">top hit(s) per reference sequence</a></li>
                        </ul>
                        <input size=5 type="text" name="evalue" id="evalue" value="" placeholder="Evalue" />
                        <button id="filter-evalue">filter</button>
                        <span>
                            <button id='view-tree'>view as</button>
                        </span>
                        <ul id="views">
                            <li id="partition" class="ui-state-highlight"><a href="#">partition</a></li>
                            <li id="table"><a href="#">table</a></li>
                            <li id="cmtv"><a href="#">cmtv</a></li>
                            <li id="tab"><a href="#">tab delimited</a></li>
                        </ul>
                    </span>
                </div>
                <div id="search-results">
                    <div id="partition">
                        <div id="partition-results"></div>
                    </div>
                    <div id="table">
                        <div id="table-results"></div>
                    </div>
                </div>
            </div>
            <div id="detailed_report_dialog" title="Quorum Report Details"></div>
        </div>
        <div id="quorum">
            <hr class="big" />
            <p>
            Powered by <a href="https://github.com/ncgr/quorum">Quorum v0.4.0</a>
            </p>
        </div>
        <script type="text/template" id="detailed_report_template">
            <h3>Query Accession {{= query }}</h3>
            {{ _.each(data, function(v) { }}
                {{ var id        = v.id }}
                {{ var qseq      = v.qseq }}
                {{ var midline   = v.midline }}
                {{ var hseq      = v.hseq }}
                {{ var q_from    = v.query_from }}
                {{ var q_to      = v.query_to }}
                {{ var h_from    = v.hit_from }}
                {{ var h_to      = v.hit_to }}
                {{ var qstrand   = v.query_frame }}
                {{ var hstrand   = v.hit_frame }}
                {{ var hsp_group = v.hsp_group }}
                {{ var linkouts  = LSS.formatLinkouts(v) }}
                <div id="{{= id }}">
                    <p class="small">{{= QUORUM.displayHspLinks(id, hsp_group, data) }}</p>
                    <p class="small">Hit Accession: {{= v.hit_display_id }}</p>
                    <p class="small">Hit Description: {{= v.hit_def }}</p>
                    <table class="report_details">
                        <tr>
                            <td>E-value: {{= parseFloat(v.evalue).toPrecision(3) }}</td>
                            <td>Bit Score: {{= v.bit_score }}</td>
                            <td>Percent Identity: {{= parseFloat(v.pct_identity).toPrecision(3) }}</td>
                        </tr>
                        <tr>
                            <td>Alignment Length: {{= v.align_len }}</td>
                            <td>Qstrand / Hstrand: {{= QUORUM.formatStrand(qstrand, hstrand) }}</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Query Length: {{= v.query_len }}</td>
                            <td>Query From: {{= v.query_from }}</td>
                            <td>Query To: {{= v.query_to }}</td>
                        </tr>
                        <tr>
                            <td>Hit Length: {{= v.hit_len }}</td>
                            <td>Hit From: {{= v.hit_from }}</td>
                            <td>Hit To: {{= v.hit_to }}</td>
                        </tr>
                    </table>
                    <p class="small">
                    {{ if (!_.isEmpty(linkouts)) { }}
                        Linkouts:<br />
                        {{ _.each(linkouts, function(l) { }}
                            <a href="{{= l.url }}" target="_blank">{{= l.name }}</a><br />
                            {{ }); }}
                        {{ } }}
                    </p>
                    <p class="small">
                    <a id="download_sequence_{{= id }}"
                        onclick="QUORUM.downloadSequence(23, {{= id }}, '{{= algo }}', this)">
                        Download Sequence
                    </a>
                    </p>
                    {{= QUORUM.formatSequenceReport(qseq, midline, hseq, q_from, q_to, h_from, h_to, algo) }}
                </div>
                <hr />
                {{ }); }}
        </script>
        <script type="text/template" id="table-view">
            <table class="results">
                <tr>
                    <th><a onclick="LSS.sortable('query')">query ID</a></th>
                    <th><a onclick="LSS.sortable('hit_id')">subject ID</a></th>
                    <th><a onclick="LSS.sortable('align_len')">align length</a></th>
                    <th><a onclick="LSS.sortable('pct_identity')">% identity</a></th>
                    <th><a onclick="LSS.sortable('evalue', parseFloat)">E-value</a></th>
                    <th><a onclick="LSS.sortable('bit_score')">bit score</a></th>
                    <th><a onclick="LSS.sortable('hit_def')">subject description</a></th>
                    <th><a onclick="LSS.sortable('algo')">algorithm</a></th>
                    <th>alignment</th>
                    <th>GBrowse</th>
                </tr>
                {{ var i = 0, style = "", linkouts }}
                {{ _.each(data, function(d) { }}
                    {{ i += 1 }}
                    <tr class="{{= i % 2 == 0 ? 'even' : 'odd' }}">
                        <td>{{= d.query }}</td>
                        <td>{{= d.hit_id }}</td>
                        <td>{{= d.align_len }}</td>
                        <td>{{= parseFloat(d.pct_identity).toPrecision(3) }}</td>
                        <td>{{= parseFloat(d.evalue).toPrecision(3) }}</td>
                        <td>{{= d.bit_score }}</td>
                        <td>{{= d.hit_def }}</td>
                        <td>{{= d.algo }}</td>
                        <td>
                            <a class="detailed_report"
                                onclick="QUORUM.viewDetailedReport(
                                {{= quorum_id }},
                                {{= d.quorum_hit_id }},
                                '{{= d.query }}',
                                '{{= d.algo }}')"
                                >view</a>
                        </td>
                        <td>
                            {{ linkouts = LSS.formatLinkouts(d) }}
                            {{ if (!_.isEmpty(linkouts)) { }}
                                {{ _.each(LSS.formatLinkouts(d), function(l) { }}
                                    <a class="detailed_report" href="{{= l.url }}" target="_blank">
                                        {{= l.name }}
                                    </a>&nbsp;
                                    {{ }); }}
                                {{ } else { }}
                                None
                                {{ } }}
                        </td>
                    </tr>
                    {{ }); }}
            </table>
        </script>
        <script type="text/javascript">
            $(function() {
              QUORUM.pollResults(23, LSS.collectResults, LSS);
            });
        </script>
    </body>
</html>
